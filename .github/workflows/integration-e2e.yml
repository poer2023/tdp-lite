name: Integration E2E

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: integration-e2e-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9.15.0"
  GO_VERSION: "1.23.x"
  NEXTAUTH_SECRET: ci-nextauth-secret
  NEXTAUTH_URL: http://127.0.0.1:3000
  TDP_API_BASE_URL: http://127.0.0.1:8080
  NEXT_PUBLIC_TDP_API_BASE_URL: http://127.0.0.1:8080
  TDP_PREVIEW_SECRET: ci-preview-secret
  TDP_CI_KEY_ID: ci_root
  TDP_CI_KEY_SECRET: ci_root_secret
  DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/tdp_lite_ci

jobs:
  smoke:
    name: Integration Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 25
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tdp_lite_ci
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d tdp_lite_ci"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply database migrations
        run: |
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f drizzle/0000_famous_captain_marvel.sql
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f backend/migrations/0001_api_platform.sql
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f backend/migrations/0002_search_fts_indexes.sql

      - name: Seed smoke data
        run: |
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 <<'SQL'
          INSERT INTO posts (id, slug, locale, title, excerpt, content, tags, status, published_at, created_at, updated_at)
          VALUES (
            'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa',
            'ci-post-smoke',
            'en',
            'CI Smoke Post',
            'smoke excerpt',
            'smoke content',
            '["ci"]'::jsonb,
            'published',
            NOW(),
            NOW(),
            NOW()
          )
          ON CONFLICT (locale, slug) DO NOTHING;

          INSERT INTO moments (id, content, media, locale, visibility, location, status, published_at, created_at, updated_at)
          VALUES (
            'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb',
            'ci smoke moment',
            '[]'::jsonb,
            'en',
            'public',
            '{"name":"CI"}'::jsonb,
            'published',
            NOW(),
            NOW(),
            NOW()
          )
          ON CONFLICT (id) DO NOTHING;

          INSERT INTO gallery (id, locale, file_url, thumb_url, title, status, published_at, created_at, updated_at)
          VALUES (
            'cccccccc-cccc-cccc-cccc-cccccccccccc',
            'en',
            'https://example.com/ci-image.jpg',
            'https://example.com/ci-thumb.jpg',
            'CI Gallery Item',
            'published',
            NOW(),
            NOW(),
            NOW()
          )
          ON CONFLICT (id) DO NOTHING;

          INSERT INTO api_keys (name, key_hash, permissions, key_id, secret_ciphertext, scopes)
          VALUES (
            'CI Root Key',
            encode(digest('ci_root_secret', 'sha256'), 'hex'),
            '["*"]'::jsonb,
            'ci_root',
            'ci_root_secret',
            '["*"]'::jsonb
          )
          ON CONFLICT (key_id)
          DO UPDATE SET
            key_hash = EXCLUDED.key_hash,
            permissions = EXCLUDED.permissions,
            secret_ciphertext = EXCLUDED.secret_ciphertext,
            scopes = EXCLUDED.scopes,
            revoked_at = NULL,
            updated_at = NOW();
          SQL

      - name: Build frontend
        run: pnpm build

      - name: Runtime smoke tests
        run: |
          set -euo pipefail

          API_PID=""
          WORKER_PID=""
          NEXT_PID=""

          cleanup() {
            status=$?
            if [ "$status" -ne 0 ]; then
              echo "----- Next logs -----"
              tail -n 200 /tmp/tdp-next.log || true
              echo "----- Go API logs -----"
              tail -n 200 /tmp/tdp-api.log || true
              echo "----- Go Worker logs -----"
              tail -n 200 /tmp/tdp-worker.log || true
            fi
            if [ -n "${NEXT_PID:-}" ]; then
              kill "$NEXT_PID" >/dev/null 2>&1 || true
              wait "$NEXT_PID" >/dev/null 2>&1 || true
            fi
            if [ -n "${WORKER_PID:-}" ]; then
              kill "$WORKER_PID" >/dev/null 2>&1 || true
              wait "$WORKER_PID" >/dev/null 2>&1 || true
            fi
            if [ -n "${API_PID:-}" ]; then
              kill "$API_PID" >/dev/null 2>&1 || true
              wait "$API_PID" >/dev/null 2>&1 || true
            fi
          }
          trap cleanup EXIT

          wait_for_url() {
            local url="$1"
            for _ in $(seq 1 120); do
              if curl -fsS "$url" >/dev/null 2>&1; then
                return 0
              fi
              sleep 1
            done
            echo "timeout waiting for $url" >&2
            return 1
          }

          assert_http_200() {
            local url="$1"
            local code
            code="$(curl -sS -o /dev/null -w "%{http_code}" "$url")"
            if [ "$code" != "200" ]; then
              echo "expected 200 from $url, got $code" >&2
              return 1
            fi
          }

          assert_search_headers() {
            local expected_source="$1"
            local expected_fallback="$2"
            local output_file="$3"

            for attempt in $(seq 1 10); do
              local headers_file
              headers_file="$(mktemp)"

              curl -sS -D "$headers_file" -o "$output_file" \
                -X POST "http://127.0.0.1:3000/api/search" \
                -H "content-type: application/json" \
                --data '{"section":"post","query":"smoke","locale":"en","filters":{"localeScope":"all"},"limit":5}'

              if grep -iq "^x-tdp-search-source: ${expected_source}" "$headers_file" &&
                grep -iq "^x-tdp-search-fallback: ${expected_fallback}" "$headers_file"; then
                rm -f "$headers_file"
                return 0
              fi

              echo "search header mismatch attempt=${attempt} expected_source=${expected_source} expected_fallback=${expected_fallback}" >&2
              cat "$headers_file" >&2
              cat "$output_file" >&2 || true
              rm -f "$headers_file"
              sleep 1
            done

            echo "search header assertions exhausted retries" >&2
            return 1
          }

          (cd backend && go build -o /tmp/tdp-api-ci ./cmd/tdp-api)
          (cd backend && go build -o /tmp/tdp-worker-ci ./cmd/tdp-worker)
          /tmp/tdp-api-ci >/tmp/tdp-api.log 2>&1 &
          API_PID=$!
          TDP_JOB_POLL_INTERVAL=1s /tmp/tdp-worker-ci >/tmp/tdp-worker.log 2>&1 &
          WORKER_PID=$!

          TDP_SEARCH_PRIMARY=go pnpm start -p 3000 >/tmp/tdp-next.log 2>&1 &
          NEXT_PID=$!

          wait_for_url "http://127.0.0.1:8080/healthz"
          wait_for_url "http://127.0.0.1:3000/en"

          assert_http_200 "http://127.0.0.1:3000/en"
          assert_http_200 "http://127.0.0.1:3000/en/posts"
          assert_http_200 "http://127.0.0.1:3000/en/posts/ci-post-smoke"
          assert_http_200 "http://127.0.0.1:3000/en/moments"
          assert_http_200 "http://127.0.0.1:3000/en/moments/bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb"
          assert_http_200 "http://127.0.0.1:3000/en/gallery"

          node scripts/ci/full-api-e2e.mjs

          assert_search_headers "go" "false" "/tmp/search-up.json"

          kill "$API_PID" >/dev/null 2>&1 || true
          wait "$API_PID" >/dev/null 2>&1 || true
          API_PID=""

          for _ in $(seq 1 30); do
            if ! curl -fsS "http://127.0.0.1:8080/healthz" >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done
          if curl -fsS "http://127.0.0.1:8080/healthz" >/dev/null 2>&1; then
            echo "expected Go API to be stopped before fallback verification" >&2
            exit 1
          fi

          assert_search_headers "next" "true" "/tmp/search-down.json"

          curl -sS "http://127.0.0.1:3000/preview/card?sid=dummy&exp=9999999999&sig=dummy" \
            | grep -q "Preview Unavailable"

          echo "integration smoke checks passed"
